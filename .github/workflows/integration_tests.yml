name: Run end-to-end tests

on:
  workflow_call:
    inputs:
      postgres-tag:
        type: string
        required: true
      postgres-db:
        type: string
        default: 'jpc'
        required: false
      postgres-password:
        type: string
        default: 'letmein'
        required: false
      postgres-username:
        type: string
        default: 'jpc'
        required: true

env:
  total-runners: 2

jobs:
  gradle_build:
    name: Gradle Build
    runs-on: ubuntu-latest
    env:
      _JAVA_OPTIONS: "-Xmx4g"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Gradle Build
        run: ./gradlew assemble testClasses --build-cache

  integration_playwright_tests:
    runs-on: ubuntu-latest
    name: "Run Playwright integration tests"
    needs: gradle_build

    services:
      # App database
      postgres:
        image: postgres:${{ inputs.postgres-tag }}
        env:
          POSTGRES_USER: ${{ inputs.postgres-username }}
          POSTGRES_PASSWORD: ${{ inputs.postgres-password }}
          POSTGRES_DB: ${{ inputs.postgres-db}}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

      # Auth service database
      authdb:
        image: postgres:${{ inputs.postgres-tag }}
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: admin_password
          POSTGRES_DB: auth-db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7432:5432

      # Real HMPPS Auth service
      auth:
        image: ghcr.io/ministryofjustice/hmpps-auth:latest
        env:
          SERVER_PORT: 9090
          SPRING_PROFILES_ACTIVE: dev,local-postgres,auth-seed
          SPRING_DATASOURCE_URL: jdbc:postgresql://authdb:5432/auth-db
          SPRING_DATASOURCE_USERNAME: admin
          SPRING_DATASOURCE_PASSWORD: admin_password
        options: >-
          --health-cmd "curl -f http://localhost:9090/auth/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 20
        ports:
          - 9090:9090

    steps:
      - name: Clone repository
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Gradle Build
        run: ./gradlew assemble testClasses --build-cache

      - name: Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            pg_isready -h localhost -p 5433 -U ${{ inputs.postgres-username }} && echo "✅ PostgreSQL is ready!" && exit 0
            echo "Attempt $i: PostgreSQL not ready, retrying..."
            sleep 2
          done
          echo "❌ PostgreSQL did not become ready"
          exit 1

      - name: Wait for Auth DB
        run: |
          echo "Waiting for Auth DB to be ready..."
          for i in {1..30}; do
            pg_isready -h localhost -p 7432 -U admin && echo "✅ Auth DB is ready!" && exit 0
            echo "Attempt $i: Auth DB not ready, retrying..."
            sleep 2
          done
          echo "❌ Auth DB did not become ready"
          exit 1

      - name: Wait for HMPPS Auth
        run: |
          echo "Waiting for HMPPS Auth to be healthy..."
          for i in {1..40}; do
            curl -fsS http://localhost:9090/auth/health && echo "✅ HMPPS Auth is healthy!" && exit 0
            echo "Attempt $i: Auth not healthy yet, retrying..."
            sleep 5
          done
          echo "❌ HMPPS Auth did not become healthy"
          exit 1

      - name: Run the Java app (from built JAR)
        run: |
          set -e
          echo "Listing JARs in build/libs:" && ls -l build/libs || true
          JAR_PATH=$(ls build/libs/calculate-journey-variable-payments-*.jar | head -n 1 || true)
          if [ -z "$JAR_PATH" ]; then
            echo "❌ Could not find app JAR in build/libs"
            exit 1
          fi
          echo "Using JAR: $JAR_PATH"
          nohup env \
            SPRING_PROFILES_ACTIVE=dev \
            SERVER_SERVLET_SESSION_COOKIE_SECURE=false \
            SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5433/${{ inputs.postgres-db }} \
            SPRING_DATASOURCE_USERNAME=${{ inputs.postgres-username }} \
            SPRING_DATASOURCE_PASSWORD=${{ inputs.postgres-password }} \
            java -Xmx1024m -jar "$JAR_PATH" > app.log 2>&1 &
          echo "App started in background with PID $!"

      - name: Wait for app to be healthy
        id: wait_health
        continue-on-error: true
        run: |
          echo "Waiting for app to be healthy..."
          for i in {1..30}; do
            echo "Attempt $i: Checking app health..."
            response=$(curl -s http://localhost:8080/health || true)
            echo "Response: $response"
            echo "$response" | grep -q '"status":"UP"' && echo "✅ App is healthy!" && exit 0
            echo "Retry $i: App not ready yet. Sleeping..."
            sleep 10
          done
          echo "❌ App did not become healthy"
          exit 1

      - name: Stop job if app failed to start
        if: steps.wait_health.outcome == 'failure'
        run: |
          echo "❌ Stopping job because the app failed to start properly. Showing app.log:"
          (test -f app.log && tail -n 200 app.log) || echo "app.log not found"
          exit 1

      - name: Run Playwright Integration tests
        run: |
          docker run --rm \
            --network host \
            -v "${{ github.workspace }}:/work" \
            -v "$HOME/.gradle:/root/.gradle" \
            -w /work \
            mcr.microsoft.com/playwright:v1.54.0-jammy \
            bash -lc '
              set -e
              apt-get update -y > /dev/null
              apt-get install -y openjdk-21-jdk curl > /dev/null
              export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
              export PATH="$JAVA_HOME/bin:$PATH"
              java -version
              ./gradlew --no-daemon --info --stacktrace testPlayWrightIntegration -Dplaywright.headless=true
            '

      - name: Upload raw test reports on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-results
          path: |
            build/test-results
            build/reports/tests

      - name: Upload HTML report (always)
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: testPlayWrightIntegration-html-report
          path: build/reports/tests/testPlayWrightIntegration
