name: Pipeline [test -> build -> deploy]

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      additional_docker_tag:
        description: Additional docker tag that can be used to specify stable or testing tags
        required: false
        default: ''
        type: string
      push:
        description: Push docker image to registry flag
        required: true
        default: false
        type: boolean
env:
  _JAVA_OPTIONS: >-
    -Xmx1024m
    -XX:ParallelGCThreads=2
    -XX:ConcGCThreads=2
    -Djava.util.concurrent.ForkJoinPool.common.parallelism=2
    -Dorg.gradle.daemon=false

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # This will cancel all running build/test/release pipelines that are not on the main branch
  # If this pipeline is on the main branch, it will wait until existing runs complete
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  helm_lint:
    strategy:
      matrix:
        environments: ['dev', 'preprod', 'prod']
    name: helm lint
    uses: ministryofjustice/hmpps-github-actions/.github/workflows/test_helm_lint.yml@v2 # WORKFLOW_VERSION
    secrets: inherit
    with:
      environment: ${{ matrix.environments }}
  kotlin_validate:
    name: Validate the kotlin
    uses: ministryofjustice/hmpps-github-actions/.github/workflows/kotlin_validate.yml@v2 # WORKFLOW_VERSION
    secrets: inherit
  docker_build:
    name: Build docker image from hmpps-github-actions
    if: github.ref == 'refs/heads/main'
    uses: ministryofjustice/hmpps-github-actions/.github/workflows/docker_build.yml@v2 # WORKFLOW_VERSION
    needs:
      - kotlin_validate
    with:
      docker_registry: 'ghcr.io'
      registry_org: 'ministryofjustice'
      additional_docker_tag: ${{ inputs.additional_docker_tag }}
      push: ${{ inputs.push || true }}
      docker_multiplatform: false

  kotlin_build:
    name: Build Kotlin JAR
    runs-on: ubuntu-latest
    needs: kotlin_validate
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permissions
        run: chmod +x ./gradlew

      - name: Build JAR
        run: ./gradlew build

      - name: Rename JAR to app.jar
        run: |
          JAR_FILE=$(ls build/libs/calculate-journey-variable-payments-*.jar | head -n 1)
          mv "$JAR_FILE" build/libs/app.jar

      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/app.jar

  integration_playwright_tests:
    needs:
      - kotlin_build
    runs-on: ubuntu-latest
    container:
      image: cimg/openjdk:21.0-browsers
      options: --name app

    steps:
      - uses: actions/checkout@v4

      - name: Install xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Install PostgreSQL client
        run: |
          sudo apt-get install -y postgresql-client

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Ensure Docker Compose is available
        run: |
          sudo apt-get update
          sudo apt-get install -y iproute2 docker-compose-plugin      

      - name: Start required containers
        run: sudo docker-compose -f docker-compose.integration.yml up -d

      - name: Wait for services from inside tester container
        run: |
          echo "Waiting for Auth service from inside tester container..."
          
          sudo docker-compose -f docker-compose.integration.yml exec -T tester /bin/sh -c '
            for i in $(seq 1 10); do
              echo "Attempt $i: curling http://auth:9090/auth/health"
              if curl --fail --silent http://auth:9090/auth/health; then
                echo "✅ Auth service is ready!"
                exit 0
              fi
              echo "Retry $i: Not ready yet. Sleeping..."
              sleep 10
            done
            echo "❌ Auth service did not become ready."
            exit 1
          '

      - name: Wait for Postgres from inside tester container
        run: |
          echo "Waiting for Postgres from inside tester container..."
          
          sudo docker-compose -f docker-compose.integration.yml exec -T tester-sql /bin/sh -c '
            for i in $(seq 1 10); do
              echo "Attempt $i: checking Postgres..."
              PGPASSWORD=letmein pg_isready -h postgres-jpc -p 5432 -U jpc -d jpc
              if [ $? -eq 0 ]; then
                echo "✅ Postgres is ready!"
                exit 0
              fi
              echo "Retry $i: Not ready yet. Sleeping..."
              sleep 10
            done
            echo "❌ Postgres did not become ready."
            exit 1
          '

      - name: Download app JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: build/libs

      - name: Build image from Dockerfile
        run: |
          sudo docker build -t app_image .

      - name: Run App container in the same network
        run: |
          NETWORK_NAME=$(sudo docker network ls --format '{{.Name}}' | grep 'app-net$')
          echo "Using network: $NETWORK_NAME"

          sudo docker run -d \
            --name my_app \
            --network $NETWORK_NAME \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=integration-tests \
            -e SERVER_SERVLET_SESSION_COOKIE_SECURE=false \
            app_image

      - name: Wait for app to be healthy (inside tester container)
        id: wait_health
        continue-on-error: true
        run: |
          echo "Waiting for app to be healthy from inside tester container..."
          sudo docker-compose -f docker-compose.integration.yml exec -T tester /bin/sh -c '
            for i in $(seq 1 20); do
              echo "Attempt $i: Checking app health..."
              response=$(curl -s http://my_app:8080/health || true)
              echo "Response: $response"
              echo "$response" | grep "\"status\":\"UP\"" > /dev/null && exit 0
              echo "Retry $i: App not ready yet. Sleeping..."
              sleep 10
            done
            exit 1
          '

      - name: Print app logs on failure
        if: steps.wait_health.outcome == 'failure'
        run: |
          echo "❌ App failed to become healthy in time."
          echo "---- app.log ----"
          sudo docker logs my_app || true
          echo "-----------------"

      - name: Run Playwright Integration Tests
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1024x768x24" ./gradlew testPlaywrightIntegration

  deploy_dev:
    name: Deploy to the development environment
    needs:
      - docker_build
      - helm_lint
    uses: ministryofjustice/hmpps-github-actions/.github/workflows/deploy_env.yml@v2 # WORKFLOW_VERSION
    secrets: inherit
    with:
      environment: 'dev'
      app_version: '${{ needs.build.outputs.app_version }}'
  # deploy_preprod:
  #   name: Deploy to pre-production environment
  #   needs:
  #     - build
  #     - deploy_dev
  #   uses: ministryofjustice/hmpps-github-actions/.github/workflows/deploy_env.yml@v2 # WORKFLOW_VERSION
  #   secrets: inherit
  #   with:
  #     environment: 'preprod'
  #     app_version: '${{ needs.build.outputs.app_version }}'
  # deploy_prod:
  #   name: Deploy to production environment
  #   needs:
  #     - build
  #     - deploy_preprod
  #   uses: ministryofjustice/hmpps-github-actions/.github/workflows/deploy_env.yml@v2 # WORKFLOW_VERSION
  #   secrets: inherit
  #   with:
  #     environment: 'prod'
  #     app_version: '${{ needs.build.outputs.app_version }}'
